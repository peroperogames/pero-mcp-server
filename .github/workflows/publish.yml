name: Create GitHub Release

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate AI-powered release notes
        id: release_notes
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: ".github/release-changelog-config.json"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Smart code analysis and changelog generation
        id: smart_analysis
        run: |
          VERSION=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          echo "ðŸ¤– å¼€å§‹æ™ºèƒ½åˆ†æž Release v$VERSION..."
          
          # åˆå§‹åŒ–å˜é‡
          SMART_SUMMARY=""
          FILES_CHANGED=0
          INSERTIONS=0
          DELETIONS=0
          FEATURES=""
          FIXES=""
          IMPROVEMENTS=""
          BREAKING_CHANGES=""
          DOCS=""

          if [ ! -z "$PREVIOUS_TAG" ]; then
            echo "ðŸ“Š åˆ†æžä»Ž $PREVIOUS_TAG åˆ° v$VERSION çš„å˜æ›´..."
            
            # èŽ·å–è¯¦ç»†ç»Ÿè®¡
            FILES_CHANGED=$(git diff --name-only $PREVIOUS_TAG..HEAD | wc -l)
            STAT_OUTPUT=$(git diff --shortstat $PREVIOUS_TAG..HEAD)
            INSERTIONS=$(echo "$STAT_OUTPUT" | grep -o '[0-9]\+ insertion' | grep -o '[0-9]\+' || echo "0")
            DELETIONS=$(echo "$STAT_OUTPUT" | grep -o '[0-9]\+ deletion' | grep -o '[0-9]\+' || echo "0")
            
            # åˆ†æžæ–‡ä»¶ç±»åž‹å˜æ›´
            PYTHON_COUNT=$(git diff --name-only $PREVIOUS_TAG..HEAD | grep '\.py$' | wc -l)
            CONFIG_COUNT=$(git diff --name-only $PREVIOUS_TAG..HEAD | grep -E '\.(yml|yaml|json|toml)$' | wc -l)
            DOC_COUNT=$(git diff --name-only $PREVIOUS_TAG..HEAD | grep -E '\.(md|rst|txt)$' | wc -l)
            
            # æ™ºèƒ½åˆ†æžæäº¤æ¶ˆæ¯
            ALL_COMMITS=$(git log --pretty=format:"%s" $PREVIOUS_TAG..HEAD)
            
            # åˆ†ç±»æäº¤æ¶ˆæ¯
            FEATURES=$(echo "$ALL_COMMITS" | grep -E "^(feat|feature|add|implement|æ–°å¢ž|æ·»åŠ )" | head -10)
            FIXES=$(echo "$ALL_COMMITS" | grep -E "^(fix|bug|patch|resolve|ä¿®å¤|è§£å†³)" | head -10)
            IMPROVEMENTS=$(echo "$ALL_COMMITS" | grep -E "^(improve|enhance|optimize|refactor|update|ä¼˜åŒ–|æ”¹è¿›|é‡æž„)" | head -10)
            BREAKING_CHANGES=$(echo "$ALL_COMMITS" | grep -E "(BREAKING|!:|major|é‡å¤§å˜æ›´)" | head -5)
            DOCS=$(echo "$ALL_COMMITS" | grep -E "^(docs|doc|documentation|readme|æ–‡æ¡£)" | head -10)
            
            # ç”Ÿæˆæ™ºèƒ½æ‘˜è¦
            FEATURE_COUNT=$(echo "$FEATURES" | grep -v '^$' | wc -l)
            FIX_COUNT=$(echo "$FIXES" | grep -v '^$' | wc -l)
            IMP_COUNT=$(echo "$IMPROVEMENTS" | grep -v '^$' | wc -l)
            BREAK_COUNT=$(echo "$BREAKING_CHANGES" | grep -v '^$' | wc -l)
            
            if [ $BREAK_COUNT -gt 0 ]; then
              SMART_SUMMARY="âš ï¸ åŒ…å« $BREAK_COUNT ä¸ªé‡å¤§å˜æ›´"
            fi
            
            if [ $FEATURE_COUNT -gt 0 ]; then
              if [ ! -z "$SMART_SUMMARY" ]; then
                SMART_SUMMARY="$SMART_SUMMARYï¼Œæ–°å¢ž $FEATURE_COUNT ä¸ªåŠŸèƒ½"
              else
                SMART_SUMMARY="æ–°å¢ž $FEATURE_COUNT ä¸ªåŠŸèƒ½ç‰¹æ€§"
              fi
            fi
            
            if [ $FIX_COUNT -gt 0 ]; then
              if [ ! -z "$SMART_SUMMARY" ]; then
                SMART_SUMMARY="$SMART_SUMMARYï¼Œä¿®å¤ $FIX_COUNT ä¸ªé—®é¢˜"
              else
                SMART_SUMMARY="ä¿®å¤ $FIX_COUNT ä¸ªé—®é¢˜"
              fi
            fi
            
            if [ $IMP_COUNT -gt 0 ]; then
              if [ ! -z "$SMART_SUMMARY" ]; then
                SMART_SUMMARY="$SMART_SUMMARYï¼ŒåŒ…å« $IMP_COUNT é¡¹æ”¹è¿›"
              else
                SMART_SUMMARY="åŒ…å« $IMP_COUNT é¡¹ä»£ç æ”¹è¿›"
              fi
            fi
            
            # å¦‚æžœæ²¡æœ‰åˆ†ç±»åˆ°çš„æäº¤ï¼Œä½¿ç”¨é€šç”¨æè¿°
            if [ -z "$SMART_SUMMARY" ]; then
              COMMIT_COUNT=$(echo "$ALL_COMMITS" | wc -l)
              SMART_SUMMARY="åŒ…å« $COMMIT_COUNT ä¸ªæäº¤çš„å¸¸è§„æ›´æ–°"
            fi
            
            echo "ðŸŽ¯ æ™ºèƒ½åˆ†æžå®Œæˆï¼š"
            echo "  - æ–‡ä»¶å˜æ›´: $FILES_CHANGED"
            echo "  - Pythonæ–‡ä»¶: $PYTHON_COUNT"
            echo "  - é…ç½®æ–‡ä»¶: $CONFIG_COUNT" 
            echo "  - æ–‡æ¡£æ–‡ä»¶: $DOC_COUNT"
            echo "  - åŠŸèƒ½: $FEATURE_COUNT, ä¿®å¤: $FIX_COUNT, æ”¹è¿›: $IMP_COUNT"
            
          else
            # é¦–æ¬¡å‘å¸ƒ
            SMART_SUMMARY="ðŸŽ‰ é¦–æ¬¡å‘å¸ƒå®Œæ•´çš„MCPæœåŠ¡å™¨å®žçŽ°"
            FILES_CHANGED=$(find . -name "*.py" -o -name "*.yml" -o -name "*.yaml" -o -name "*.json" -o -name "*.md" | grep -v __pycache__ | wc -l)
            FEATURES="å®Œæ•´çš„MCPæœåŠ¡å™¨æ¡†æž¶å®žçŽ°
          SSHå®¢æˆ·ç«¯æ”¯æŒå’Œè¿žæŽ¥ç®¡ç†
          App Store Connect APIé›†æˆ
          çµæ´»çš„é…ç½®åŒ–æž¶æž„"
            DOCS="å®Œæ•´çš„READMEæ–‡æ¡£å’Œä½¿ç”¨è¯´æ˜Ž
          è¯¦ç»†çš„APIæ–‡æ¡£å’Œç¤ºä¾‹
          MCPå®¢æˆ·ç«¯é…ç½®æŒ‡å—"
          fi
          
          # ç”Ÿæˆæœ€ç»ˆçš„å‘å¸ƒè¯´æ˜Ž
          cat > release_notes.md << EOF
          ## ðŸš€ Release $VERSION
          
          ### ðŸ¤– æ‘˜è¦
          $SMART_SUMMARY
          
          ### ðŸ“Š å‘å¸ƒç»Ÿè®¡
          - ðŸ“ **å˜æ›´æ–‡ä»¶**: $FILES_CHANGED ä¸ª
          - âž• **æ–°å¢žä»£ç **: $INSERTIONS è¡Œ
          - âž– **åˆ é™¤ä»£ç **: $DELETIONS è¡Œ
          - ðŸ **Pythonæ–‡ä»¶**: $PYTHON_COUNT ä¸ª
          - âš™ï¸ **é…ç½®æ–‡ä»¶**: $CONFIG_COUNT ä¸ª
          - ðŸ“š **æ–‡æ¡£æ–‡ä»¶**: $DOC_COUNT ä¸ª
          
          ### âœ¨ æ–°åŠŸèƒ½ç‰¹æ€§
          EOF
          
          if [ ! -z "$FEATURES" ] && [ "$FEATURES" != " " ]; then
            echo "$FEATURES" | while read -r line; do
              if [ ! -z "$line" ]; then
                echo "- $line" >> release_notes.md
              fi
            done
          else
            echo "- æœ¬ç‰ˆæœ¬æ— æ–°åŠŸèƒ½ç‰¹æ€§" >> release_notes.md
          fi
          
          cat >> release_notes.md << EOF
          
          ### ðŸ› é—®é¢˜ä¿®å¤
          EOF
          
          if [ ! -z "$FIXES" ] && [ "$FIXES" != " " ]; then
            echo "$FIXES" | while read -r line; do
              if [ ! -z "$line" ]; then
                echo "- $line" >> release_notes.md
              fi
            done
          else
            echo "- æœ¬ç‰ˆæœ¬æ— é—®é¢˜ä¿®å¤" >> release_notes.md
          fi
          
          cat >> release_notes.md << EOF
          
          ### ðŸ”§ æ”¹è¿›ä¼˜åŒ–
          EOF
          
          if [ ! -z "$IMPROVEMENTS" ] && [ "$IMPROVEMENTS" != " " ]; then
            echo "$IMPROVEMENTS" | while read -r line; do
              if [ ! -z "$line" ]; then
                echo "- $line" >> release_notes.md
              fi
            done
          else
            echo "- æœ¬ç‰ˆæœ¬æ— æ”¹è¿›ä¼˜åŒ–" >> release_notes.md
          fi
          
          # æ·»åŠ é‡å¤§å˜æ›´ï¼ˆå¦‚æžœæœ‰ï¼‰
          if [ ! -z "$BREAKING_CHANGES" ] && [ "$BREAKING_CHANGES" != " " ]; then
            cat >> release_notes.md << EOF
          
          ### âš ï¸ é‡å¤§å˜æ›´
          EOF
            echo "$BREAKING_CHANGES" | while read -r line; do
              if [ ! -z "$line" ]; then
                echo "- $line" >> release_notes.md
              fi
            done
          fi
          
          cat >> release_notes.md << EOF
          
          ### ðŸ“š æ–‡æ¡£æ›´æ–°
          EOF
          
          if [ ! -z "$DOCS" ] && [ "$DOCS" != " " ]; then
            echo "$DOCS" | while read -r line; do
              if [ ! -z "$line" ]; then
                echo "- $line" >> release_notes.md
              fi
            done
          else
            echo "- æœ¬ç‰ˆæœ¬æ— æ–‡æ¡£æ›´æ–°" >> release_notes.md
          fi
          
          cat >> release_notes.md << EOF
          
          ### ðŸ“¦ å¿«é€Ÿå®‰è£…
          \`\`\`bash
          # æŽ¨èä½¿ç”¨ uvxï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰
          uvx --from git+https://github.com/peroperogames/pero-mcp-server@v$VERSION pero-mcp-server
          
          # æˆ–è€…å…‹éš†åˆ°æœ¬åœ°è¿è¡Œ
          git clone https://github.com/peroperogames/pero-mcp-server.git
          cd pero-mcp-server
          git checkout v$VERSION
          pip install -r requirements.txt
          python __main__.py
          \`\`\`
          
          ### ðŸ”§ MCPå®¢æˆ·ç«¯é…ç½®
          \`\`\`json
          {
            "servers": {
              "pero-mcp-server": {
                "command": "uvx",
                "args": [
                  "--from",
                  "git+https://github.com/peroperogames/pero-mcp-server@v$VERSION",
                  "pero-mcp-server"
                ],
                "env": {
                  "SSH_HOST": "your_ssh_host",
                  "SSH_USERNAME": "your_username", 
                  "SSH_PORT": "22",
                  "SSH_PASSWORD": "your_password",
                  "APPSTORE_KEY_ID": "your_key_id",
                  "APPSTORE_ISSUER_ID": "your_issuer_id",
                  "APPSTORE_PRIVATE_KEY": "your_private_key"
                }
              }
            }
          }
          \`\`\`
          
          ### ðŸ› ï¸ æŠ€æœ¯è§„æ ¼
          - **Pythonç‰ˆæœ¬**: 3.8+
          - **åè®®æ”¯æŒ**: Model Context Protocol (MCP)
          - **APIé›†æˆ**: SSH, App Store Connect
          - **è®¸å¯è¯**: MIT
          - **ä»“åº“**: [pero-mcp-server](https://github.com/peroperogames/pero-mcp-server)
          
          ### ðŸ“ˆ è·¯çº¿å›¾
          - ç»§ç»­ä¼˜åŒ–æ€§èƒ½å’Œç¨³å®šæ€§
          - æ‰©å±•æ›´å¤šAPIé›†æˆé€‰é¡¹
          - æ”¹è¿›é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
          - æ·»åŠ æ›´å¤šçµæ´»çš„é…ç½®é€‰é¡¹
          
          ---
          
          **å®Œæ•´å˜æ›´æ—¥å¿—**: [\`$PREVIOUS_TAG..v$VERSION\`](https://github.com/peroperogames/pero-mcp-server/compare/$PREVIOUS_TAG...v$VERSION)
          EOF
          
          echo "âœ… ç”Ÿæˆçš„AIå¢žå¼ºå‘å¸ƒè¯´æ˜Ž:"
          echo "===================="
          cat release_notes.md
          echo "===================="

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: "ðŸŽ‰ Release ${{ steps.smart_analysis.outputs.VERSION }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          make_latest: true
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release completion summary
        run: |
          VERSION=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          echo "ðŸŽŠ ===== ðŸ¤– AIå¢žå¼ºå‘å¸ƒå®Œæˆ ===== ðŸŽŠ"
          echo ""
          echo "âœ… æˆåŠŸåˆ›å»º GitHub Release v$VERSION"
          echo "ðŸ”— å‘å¸ƒé¡µé¢: https://github.com/peroperogames/pero-mcp-server/releases/tag/v$VERSION"
          echo ""
          echo "ðŸš€ ä¸€é”®å®‰è£…å‘½ä»¤:"
          echo "uvx --from git+https://github.com/peroperogames/pero-mcp-server@v$VERSION pero-mcp-server"
          echo ""
          echo "ðŸŽ¯ æœ¬æ¬¡å‘å¸ƒçš„AIå¢žå¼ºåŠŸèƒ½:"
          echo "  ðŸ“Š æ™ºèƒ½ä»£ç ç»Ÿè®¡å’Œåˆ†æž"
          echo "  ðŸ·ï¸ è‡ªåŠ¨æäº¤æ¶ˆæ¯åˆ†ç±»"
          echo "  ðŸ“ ç»“æž„åŒ–å˜æ›´è¯´æ˜Žç”Ÿæˆ"
          echo "  ðŸ” æ–‡ä»¶ç±»åž‹å˜æ›´åˆ†æž"
          echo "  ðŸ“ˆ è¯¦ç»†çš„å‘å¸ƒç»Ÿè®¡æ•°æ®"
          echo "  âš¡ å®Œå…¨è‡ªåŠ¨åŒ–çš„å‘å¸ƒæµç¨‹"
          echo ""
          echo "ðŸŽ‰ äº«å—æ‚¨çš„æ–°ç‰ˆæœ¬å‘å¸ƒå§ï¼"
