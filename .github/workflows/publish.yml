name: Create GitHub Release

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          # ÁîüÊàêÂèëÂ∏ÉËØ¥Êòé
          cat > release_notes.md << EOF
          ## üöÄ Release $VERSION
          
          ### üì¶ Installation
          \`\`\`bash
          # Using uvx (recommended)
          uvx --from git+https://github.com/peroperogames/pero-mcp-server main
          
          # Or clone and run locally
          git clone https://github.com/peroperogames/pero-mcp-server.git
          cd pero-mcp-server
          pip install -r requirements.txt
          python __main__.py
          \`\`\`
          
          ### üîÑ Changes
          $(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD 2>/dev/null || echo "- Initial release")
          
          ### üõ†Ô∏è Technical Details
          - Python version: 3.8+
          - License: MIT
          - Repository: [pero-mcp-server](https://github.com/peroperogames/pero-mcp-server)
          
          ### üìã MCP Client Configuration
          \`\`\`json
          {
            "servers": {
              "pero-mcp-server": {
                "command": "uvx",
                "args": [
                  "--from",
                  "git+https://github.com/peroperogames/pero-mcp-server@v$VERSION",
                  "main"
                ],
                "env": {
                  "SSH_HOST": "your_ssh_host",
                  "SSH_USERNAME": "your_username",
                  "SSH_PORT": "22",
                  "SSH_PASSWORD": "your_password",
                  "APPSTORE_KEY_ID": "your_key_id",
                  "APPSTORE_ISSUER_ID": "your_issuer_id",
                  "APPSTORE_PRIVATE_KEY": "your_private_key"
                }
              }
            }
          }
          \`\`\`
          EOF
          
          echo "Generated release notes:"
          cat release_notes.md

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: "Release ${{ steps.release_notes.outputs.VERSION }} üéâ"
          body_path: release_notes.md
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post-release summary
        run: |
          VERSION=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          echo "‚úÖ Successfully created GitHub Release v$VERSION"
          echo "üéâ Release URL: https://github.com/peroperogames/pero-mcp-server/releases/tag/v$VERSION"
          echo ""
          echo "üöÄ Installation command:"
          echo "uvx --from git+https://github.com/peroperogames/pero-mcp-server@v$VERSION main"
